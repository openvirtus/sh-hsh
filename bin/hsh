#!/bin/sh -e
#L:
#l:  Copyright (c) 2018 Openvirtus.com, http://openvirtus.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#L:
#h: Usage: hsh [FLAGS...] SCRIPT [ARGS...]
#h:
#h: Shell script wrapper and remote execution tool.
#h:
#h: ## Bundle generator             ## Analysis
#h:                                 
#h: -o FILE|- : Generate bundle.    -d : Print dependencies.
#h:
#h: ## Installer.
#h:
#h: -i NAME      : Install to /usr/local/bin. Can be used with `-r`.
#h:
#h: ## SSH Execution.
#h:
#h: -S           : Run with sudo.
#h: -r USER@HOST : Run on a remote system using SSH.
#h:
#h: ## WINE,ADB and DOCKER Execution.
#h: 
#h: -w SH.EXE      : Run using wine.
#h: -a             : Use `adb` on android.
#h: -c CONTAINER|- : Run in container.
#::
#a: [ADMIN] Shell script standalone bundle generator.
set -e
hsh() {

    
    ## Parse arguments.
    local OPTIND optopt= ops= output= remote= install= wine= adb=
    local service= service_type= executable= launcher= container=
    while getopts "do:r:i:p:w:ac:S" optopt;do # OPTARG
        case $optopt in
            d)  local ops="$ops$optopt"   ;;
            o)  local output="$OPTARG"    ;;
            r)  local remote="$OPTARG"    ;;
            i)  local install="$OPTARG"   ;;
            w)  local wine="$OPTARG"      ;;
	    c)  if test @"$OPTARG" = @"-";then
		    sudo "`which docker`" ps 
		    return 0
		else
		    local container="$OPTARG"
		fi;;
            a)  local adb=adb;;
            S)  local HSH_SUDO=sudo;;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))

    
    ## Search script.
    if test -n "$1";then
        local cmd="$1"
        shift
    else
        return 0
    fi


    ## Calculate temporary file to create and name.
    local name="${install:-`basename "$cmd"`}"
    if test -n "$remote" || test -n "$install" || test -n "$wine" || test -n "$adb" || test -n "$container";then
        local output="/tmp/$name"
    fi

    
    ## Calculate dependencies and solve full path.
    local dependencies="`hsh_deps "$cmd" | awk '!seen[$0]++'`"
    local launcher="`echo "$dependencies" | tail -n 1`"

    
    ## Print dependencies.
    case "$ops" in *d*) echo "$dependencies";; esac

    
    ## Create bundle.
    if test -n "$output";then
        hsh_compile "$output" $dependencies
    fi

    
    ## Remote.
    if test -n "$remote";then
        local output_directory="/tmp/hsh/\$USER"
        cat "${output}" | ssh "${remote}" "
        mkdir -p $output_directory
        chmod a+rwx $output_directory
        cat > $output_directory/$name
        "
        if test -n "$install";then
            echo "hsh: Installing $remote:/usr/local/bin/$install ..." >&2
            ssh -o LogLevel=QUIET "$remote" \
                "sudo mv $output_directory/$name /usr/local/bin/$install && sudo chmod +x /usr/local/bin/$install"
            local launcher="/usr/local/bin/$install"
        else
            ssh -o LogLevel=QUIET -t "$remote" "${HSH_SUDO} /bin/sh -e $output_directory/$name $*"
            local launcher=""
        fi
    elif test -n "$install";then
        echo "hsh: Installing /usr/local/bin/$install ..." >&2
        sudo mv "$output" "/usr/local/bin/$install"
        sudo chmod +x "/usr/local/bin/$install"
        local launcher="/usr/local/bin/$install"
    elif test -n "$wine";then
        case "$wine" in
            *busybox*) WINEDEBUG="fixme-winediag" wine "$wine" sh "$output" "$@";;
            *)         WINEDEBUG="fixme-winediag" wine "$wine"    "$output" "$@";;
        esac
    elif test -n "$adb";then
        adb push "$output" /data/local/tmp >/dev/null
        adb shell sh "/data/local/tmp/`basename "$output"` $*"
    elif test -n "$container";then
        local t="/tmp/`basename $output`"
	sudo docker start "$container" > /dev/null
        cat "$output" | sudo docker exec -i "$container" sh -ec "rm -f '$t' && cat > '$t' && chmod +x '$t'"
        sudo docker exec -it "$container" /bin/bash -el "$t" "$@"
    fi
}
hsh_deps() {
    if test -f "$1";then
        local f="$1" l=""
    else
        local f="`which "$1"`" l=""
    fi
    if test ! -f "${f}";then
        echo "hsh: error: Can't find ${1}." >&2
        exit 1
    fi
    for l in `sed -n 's|^\. \(.*\)|\1|p;/()/q' "${f}"`;do
        if test -n "$l";then
            hsh_deps "$l"
        fi
    done
    echo "$f"
}
hsh_compile() {
    local o="$1" n="`basename "$1"`" f=; shift
    if test @"$o" = @"-";then local o=/dev/stdout;fi
    echo "#!/bin/sh"                    > "$o"
    echo "# BUNDLE FILE, DO NOT EDIT." >> "$o"
    while test -n "$1";do
        if test -n "$2";then
            sed '/^\. \(.*\)/d;''/^ *#[hlL]:/d' "$1"  >> "$o"
        else
            sed '/^\. \(.*\)/d;'"s/@\"*`basename "$1"`\"*/@\"$n\"/g" "$1" >> "$o"
        fi
        shift
    done
    chmod +x "$o"
}





## ---------------------------------------------------------------------------------------------------
if test @"`basename "$0"`" = @"hsh";then
    if test -n "$1";then
        hsh "$@"
    else
        sed -n 's/^ *#h: \{0,1\}//p' "$0" | sed "s|\\\$0|`basename $0`|g"
        echo ""
        sed -n 's/^ *#l: \{0,2\}//p' "$0"
    fi
fi
